/**
 * jQuery ddMultipleInput Plugin
 * @version: 1.2.1 (2014-01-09)
 * 
 * @uses jQuery 1.7.2
 * @uses jQuery-UI 1.10 autocomplete
 * @uses jQuery-UI 1.10 sortable
 * 
 * @param source {array} - Источник данных для ввода (то, что будет в выпадающем списке). @required
 * @param separator {string} - Разделитель между значениями. Default: ','.
 * @param allowDoubling {boolean} - Разрешить ли выбор одинаковых значений. Default: false.
 * @param max {integer} - Максимальное количество выбранных значений (при == 0 — без ограничений). Default: 0. 
 * 
 * @copyright 2014, DivanDesign
 * http://www.DivanDesign.biz
 */

(function(c){c.fn.ddMultipleInput=function(d){d=c.extend({separator:",",allowDoubling:!1,max:0},d||{});if(d.source)return"string"==c.type(d.source[0])&&c.each(d.source,function(a,c){d.source[a]={label:c,value:c}}),c(this).each(function(){var a=c(this),g=c.trim(a.val()),e=c('<div class="ddMultipleInput"></div>'),f=c('<input type="text" value="" />'),n={display:"inline-block",width:a.width()||"auto","padding-top":0,"padding-right":0,"padding-bottom":a.css("padding-bottom"),"padding-left":0,"border-top":a.css("border-top"),
"border-right":a.css("border-right"),"border-bottom":a.css("border-bottom"),"border-left":a.css("border-left"),"border-color":a.css("border-color"),"border-radius":a.css("border-radius"),overflow:"hidden","background-image":a.css("background-image"),"background-repeat":a.css("background-repeat"),"background-color":a.css("background-color"),"box-shadow":a.css("box-shadow"),cursor:"text","font-family":a.css("font-family"),"font-size":a.css("font-size"),"font-style":a.css("font-style"),"font-weight":a.css("font-weight"),
"line-height":a.css("line-height"),color:a.css("color"),"text-shadow":a.css("text-shadow"),"white-space":"normal"};a.on("ddMIaddItem",function(s,b){if(b&&c.isPlainObject(b)){f.val("").css({width:"1em"});f.before(c('<span data-value="'+b.value+'" data-label="'+b.label+'">'+b.label+' <span class="ddMultipleInput_closeIcon">\u00d7</span></span>').css({display:"inline-block",margin:a.css("padding-top")+" "+a.css("padding-right")+" 0 "+a.css("padding-left"),"border-width":"1px","border-style":"solid",
"border-color":n["border-color"],padding:"0 0.38em","border-radius":"3px",cursor:"pointer"}));g.push(b.value);if(!d.allowDoubling){for(var k=f.autocomplete("option","source"),e=0,h=k.length;e<h;e++)if(k[e].value==b.value){k.splice(e,1);break}f.autocomplete("option","source",k)}0!=d.max&&g.length==d.max&&f.hide()}});a.on("ddMIremoveItem",function(a,b){b&&""!=c.trim(b)&&e.find('span[data-value="'+b+'"]').trigger("click")});a.on("ddMIopen",function(){f.autocomplete("search","")});a.on("ddMIclose",function(){f.autocomplete("close")});
e.on("click",".ddMultipleInput_closeIcon",function(){var a=c(this).parent(),b=a.attr("data-value"),e=c.inArray(b,g);-1!=e&&(g.splice(e,1),d.allowDoubling||(e=f.autocomplete("option","source"),e.push({label:a.attr("data-label"),value:b}),f.autocomplete("option","source",e)),0!=d.max&&f.show());a.remove()});e.on("click",function(){f.trigger("focus")}).on("dblclick",function(){(0==d.max||g.length<d.max)&&a.trigger("ddMIopen")});f.on("focusin",function(a){e.addClass("focus")}).on("focusout",function(){e.removeClass("focus");
a.val(g.join(d.separator))}).on("keydown",function(a){var b=c(this),d=b.val();a.keyCode===c.ui.keyCode.TAB&&b.data("ui-autocomplete").menu.active&&a.preventDefault();a.keyCode===c.ui.keyCode.BACKSPACE&&""==d&&e.find("span:last").trigger("click");b.css({width:d.length+1+"em"})});e.css(n).insertBefore(a);f.css({width:"1em",padding:"0",border:"none",margin:"0","box-shadow":"none",outline:"none"});a.appendTo(e).hide();f.appendTo(e);a.data("ddMultipleInput",f);f.autocomplete({minLength:0,delay:0,source:c.extend([],
d.source),select:function(c,b){a.trigger("ddMIaddItem",[b.item]);return!1}});e.sortable({placeholder:"ddMultipleInput_dropPlaceholder",start:function(a,b){c(".ddMultipleInput_dropPlaceholder").css({width:b.item.css("width"),height:b.item.css("height"),padding:b.item.css("padding"),margin:b.item.css("margin"),border:b.item.css("border")})},update:function(){var f=[];c("span[data-value]",e).each(function(){var a=c(this);f.push(a.attr("data-value"))});a.val(f.join(d.separator))}});if(""!=g)for(var p=
g.split(d.separator),g=[],l=0,q=p.length;l<q;l++){for(var m=!1,h=0,r=d.source.length;h<r;h++)if(d.source[h].value==p[l]){m=d.source[h];break}!1!==m&&a.trigger("ddMIaddItem",[m])}else g=[]})}})(jQuery);